<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>íšŒì›ê°€ì… - FOOTBALLOG</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    body {
      background: linear-gradient(135deg, #1f2c4c, #3a506b);
      font-family: 'Segoe UI', sans-serif;
      color: white;
      margin: 0;
    }
    main.signup-container {
      max-width: 450px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px 30px;
      margin: 80px auto;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    h2 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 30px;
    }
    .input-group {
      margin-bottom: 18px;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .input-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    .input-group input::placeholder {
      color: #ccc;
    }
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background-color: #00aaff;
      color: white;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #0077cc;
    }
    #verifySection {
      display: none;
    }
    .login-link {
      text-align: center;
      margin-top: 15px;
    }
    .login-link a {
      color: #00c3ff;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <main class="signup-container">
    <h2>íšŒì›ê°€ì…</h2>
    <form onsubmit="event.preventDefault(); signupUser();">
      <div class="input-group">
        <label for="name">ì´ë¦„</label>
        <input type="text" id="name" required />
      </div>
     <div class="input-group">
  <label for="email">ì´ë©”ì¼</label>
  <input type="email" id="email" required />
  <small id="email-status" style="font-size: 12px; display: block; margin-top: 4px;"></small>
  <button type="button" onclick="sendVerificationEmail()">ì¸ì¦ ë©”ì¼ ì „ì†¡</button>
</div>

      <div id="verifySection">
        <p style="font-size:14px;">ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
        <button type="button" onclick="checkEmailVerification()">ì¸ì¦ ì™„ë£Œ í™•ì¸</button>
        <p id="verificationResult" style="margin-top: 5px;"></p>
      </div>
      <div class="input-group">
        <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="password" required />
      </div>
      <div class="input-group">
        <label for="confirm-password">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
        <input type="password" id="confirm-password" required />
      </div>
<div class="input-group">
  <label for="nickname">ë‹‰ë„¤ì„</label>
  <input type="text" id="nickname" required style="margin-bottom: 8px;" />
  <button type="button" onclick="checkNickname()" style="width: 100%; padding: 10px;">ì¤‘ë³µí™•ì¸</button>
  <small id="nickname-status" style="font-size: 12px; display: block; margin-top: 4px;"></small>
</div>


      <div class="input-group">
        <label for="age">ë‚˜ì´</label>
        <input type="number" id="age" required />
      </div>
      <div class="input-group">
        <label for="phone">ì „í™”ë²ˆí˜¸</label>
        <input type="tel" id="phone" required />
      </div>
      <button type="submit">íšŒì›ê°€ì…</button>
    </form>
    <p class="login-link">
      ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="login.html">ë¡œê·¸ì¸</a>
    </p>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

let nicknameChecked = false;
let lastCheckedNickname = "";

document.getElementById("nickname").addEventListener("input", () => {
  nicknameChecked = false;
  document.getElementById("nickname-status").textContent = "";
});

import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

window.checkNickname = async () => {
  const nickname = document.getElementById("nickname").value.trim();
  const statusEl = document.getElementById("nickname-status");

  if (!nickname) {
    statusEl.textContent = "âŒ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    statusEl.style.color = "red";
    nicknameChecked = false;
    return;
  }

  try {
    const q = query(collection(db, "users"), where("nickname", "==", nickname));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
      statusEl.textContent = "âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
      statusEl.style.color = "red";
      nicknameChecked = false;
    } else {
      statusEl.textContent = "âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
      statusEl.style.color = "lightgreen";
      nicknameChecked = true;
      lastCheckedNickname = nickname;
    }
  } catch (err) {
    statusEl.textContent = "ì˜¤ë¥˜: " + err.message;
    statusEl.style.color = "red";
    nicknameChecked = false;
  }
};



    const firebaseConfig = {
      apiKey: "AIzaSyA02saQDvqMQbDLrD5UMwX848E6eFO-rUU",
      authDomain: "northern-cooler-461505-d5.firebaseapp.com",
      projectId: "northern-cooler-461505-d5",
      storageBucket: "northern-cooler-461505-d5.appspot.com",
      messagingSenderId: "57199546606",
      appId: "1:57199546606:web:b4e134094c86623e25a3ff"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let verifiedEmail = null;

   window.sendVerificationEmail = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  const statusEl = document.getElementById('email-status');

  statusEl.textContent = ""; // ì´ˆê¸°í™”

  if (!email || !password) {
    statusEl.textContent = "â— ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
    statusEl.style.color = "red";
    return;
  }

  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await sendEmailVerification(userCred.user);

    verifiedEmail = userCred.user;
    document.getElementById('verifySection').style.display = 'block';

    statusEl.textContent = "âœ… ì¸ì¦ ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì„ í™•ì¸í•˜ì„¸ìš”.";
    statusEl.style.color = "lightgreen";
  } catch (e) {
    statusEl.textContent = "âŒ ì´ë¯¸ ê°€ì…ëœ ë©”ì¼ì…ë‹ˆë‹¤. ";
    statusEl.style.color = "red";
  }
};


    window.checkEmailVerification = async () => {
      if (!verifiedEmail) return alert("ë¨¼ì € ì¸ì¦ ë©”ì¼ì„ ì „ì†¡í•˜ì„¸ìš”.");
      await verifiedEmail.reload();
      if (verifiedEmail.emailVerified) {
        document.getElementById("verificationResult").textContent = "âœ… ì¸ì¦ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
      } else {
        document.getElementById("verificationResult").textContent = "â— ì¸ì¦ì´ ì•„ì§ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
    };

    window.signupUser = async () => {
      const name = document.getElementById("name").value.trim();
      const nickname = document.getElementById("nickname").value.trim();
      const age = document.getElementById("age").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const password = document.getElementById("password").value.trim();
      const confirmPassword = document.getElementById("confirm-password").value.trim();

      const submitBtn = document.querySelector("button[type='submit']");
      submitBtn.disabled = true;
      submitBtn.textContent = "ì²˜ë¦¬ ì¤‘...";

      if (!verifiedEmail || !verifiedEmail.emailVerified) {
        alert("â— ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
        submitBtn.disabled = false;
        submitBtn.textContent = "íšŒì›ê°€ì…";
        return;
      }

      if (password !== confirmPassword) {
        alert("â— ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        submitBtn.disabled = false;
        submitBtn.textContent = "íšŒì›ê°€ì…";
        return;
      }
// ğŸ”½ ì—¬ê¸°ì— ì¶”ê°€!
if (!nicknameChecked || nickname !== lastCheckedNickname) {
  alert("â— ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.");
  submitBtn.disabled = false;
  submitBtn.textContent = "íšŒì›ê°€ì…";
  return;
}


      try {
        await setDoc(doc(db, "users", verifiedEmail.uid), {
          name, nickname, age, phone, email: verifiedEmail.email, uid: verifiedEmail.uid
        });
        alert("ğŸ‰ íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        window.location.href = "login.html";
      } catch (e) {
        alert("âŒ íšŒì› ì •ë³´ ì €ì¥ ì‹¤íŒ¨: " + e.message);
        submitBtn.disabled = false;
        submitBtn.textContent = "íšŒì›ê°€ì…";
      }
    };
  </script>
</body>
</html>
